name: Security â€” Bandit

on:
  push:
    branches: [ main ]
    paths: [ "**/*.py", "pyproject.toml", "requirements*.txt" ]
  pull_request:

permissions:
  contents: read
  security-events: write  # needed to upload SARIF to Code Scanning

jobs:
  bandit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install Bandit (with SARIF support)
        run: |
          python -m pip install --upgrade pip
          pip install "bandit[sarif]"

      - name: Run Bandit (SARIF output)
        run: |
          bandit -r . \
            --format sarif --output bandit.sarif \
            --severity-level medium \
            --confidence-level medium

      - name: Upload SARIF to Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit.sarif
